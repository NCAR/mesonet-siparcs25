<!DOCTYPE html>
<html>
<head>
    <title>Real-Time Sensor Network Map</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; padding: 0; }
        #map { height: 100vh; width: 100vw; }
        .station-marker {
            background: #3388ff;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-weight: bold;
            border: 2px solid white;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
        }
        .station-popup {
            min-width: 200px;
            font-size: 14px;
        }
        .station-popup h3 {
            margin: 0 0 10px 0;
            padding-bottom: 5px;
            border-bottom: 1px solid #eee;
        }
        .station-popup table {
            width: 100%;
            border-collapse: collapse;
        }
        .station-popup td {
            padding: 3px 5px;
            border-bottom: 1px solid #eee;
        }
        .station-popup td:first-child {
            font-weight: bold;
        }
        .timestamp {
            font-size: 0.8em;
            color: #777;
            text-align: right;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.4/socket.io.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"></script>
    <script>
        // Initialize map centered on Boulder, CO
        const locale = navigator.language || 'en-US'; // Use browser's language or default to 'en-US'
        const map = L.map('map').setView([39.9784, -105.2749], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);

        const stations = {};
        const markers = {};
        const socket = io('/http://10.219.130.204:5000');

        // Custom marker icon
        function createMarkerIcon(stationId) {
            return L.divIcon({
                className: 'station-marker',
                html: stationId,
                iconSize: [48, 48]
            });
        }

        // Create popup content
        function createPopupContent(stationId, data) {
            let html = `<div class="station-popup">
                <h3>Station ${stationId}</h3>
                <table>
                    <tr><td>Latitude</td><td>${typeof data.latitude === 'number' ? data.latitude.toFixed(6) : '-'}</td></tr>
                    <tr><td>Longitude</td><td>${typeof data.longitude === 'number' ? data.longitude.toFixed(6) : '-'}</td></tr>`;
            // Add all sensor data except coordinates
            Object.keys(data)
                // .filter(key => !['latitude', 'longitude', 'station_id', 'edge_id', 'last_update', 'timestamp'].includes(key))
                .forEach(key => {
                    html += `<tr><td>${key}</td><td>${data[key]}</td></tr>`;
                });
            html += `</table>
                <div class="timestamp">
                    ${data.timestamp ? new Date(data.timestamp).toLocaleString(locale) : 'No timestamp available'}
                </div>
            </div>`;
            return html;
        }

        // Update or create marker for a station
        function updateStationMarker(stationId, stationData) {
            console.log(`Received data for ${stationId}:`, stationData);  // Add this

            if (!stationData.latitude || !stationData.longitude || 
                isNaN(stationData.latitude) || isNaN(stationData.longitude)) {
                console.warn(`Skipping marker for station ${stationId} due to missing or invalid coordinates`);
                return;
            }

            const latLng = [stationData.latitude, stationData.longitude];
            if (markers[stationId]) {
                const existingData = markers[stationId].options.data || {};
                if (!_.isEqual(existingData, stationData)) {
                    markers[stationId].setLatLng(latLng);
                    markers[stationId].setPopupContent(createPopupContent(stationId, stationData));
                    markers[stationId].options.data = stationData;
                }
            } else {
                markers[stationId] = L.marker(latLng, {
                    icon: createMarkerIcon(stationId),
                    data: stationData
                })
                .addTo(map)
                .bindPopup(createPopupContent(stationId, stationData));
            }
        }

        // Socket.IO event handlers

        // Handles the initial data sent by the server when the client connects.
        socket.on('initial_data', data => {
            console.log('Received initial data:', data);
            if (data && data.stations) {
                Object.entries(data.stations).forEach(([id, stationData]) => {
                    stations[id] = stationData;
                    updateStationMarker(id, stationData);
                });
            }
        });

        // Handles updates for a specific station sent by the server.
        socket.on('station_update', data => {
            if (data && data.station_id && data.latitude && data.longitude) {
                stations[data.station_id] = data;
                updateStationMarker(data.station_id, data);
            }
        });

        // Handles station removal
        socket.on('station_remove', data => {
            console.log('Removing station:', data);
            if (markers[data.station_id]) {
                map.removeLayer(markers[data.station_id]);
                delete markers[data.station_id];
            }
            delete stations[data.station_id];
        });

        // Configurable periodic refresh interval
        const refreshInterval = 10000; // Default to 10 seconds

        setInterval(() => {
            fetch('/api/stations')
                .then(response => response.json())
                .then(data => {
                    console.log('Received periodic station data:', data);
                    if (data && data.stations) {
                        Object.entries(data.stations).forEach(([id, stationData]) => {
                            if (!stations[id] || !_.isEqual(stations[id], stationData)) {
                                stations[id] = stationData;
                                updateStationMarker(id, stationData);
                            }
                        });
                    }
                });
        }, refreshInterval);
    </script>
</body>
</html>
